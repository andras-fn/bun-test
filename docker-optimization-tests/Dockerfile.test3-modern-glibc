# Test 3: Modern + glibc (Debian) for comparison
FROM oven/bun:1.3 AS builder

WORKDIR /app
COPY package.json bun.lockb* ./
COPY packages/database ./packages/database
COPY apps/api ./apps/api
RUN bun install --frozen-lockfile

WORKDIR /app/apps/api
RUN echo "=== Test 3: Modern + glibc ===" && \
    bun build src/index.ts \
    --compile \
    --outfile=app \
    --target=bun-linux-x64-modern \
    --minify \
    --bytecode \
    --define:process.env.NODE_ENV=\"production\" && \
    chmod +x app && \
    echo "Size: $(du -h app)"

# Minimal Debian runtime
FROM debian:12-slim
RUN apt-get update && \
    apt-get install -y --no-install-recommends libstdc++6 libgcc-s1 && \
    rm -rf /var/lib/apt/lists/* && \
    useradd -r -s /bin/false -u 1000 app

WORKDIR /app
COPY --from=builder /app/apps/api/app ./app
USER 1000
EXPOSE 3001
CMD ["./app"]