# Optimized compiled Bun executable - Smaller version
FROM oven/bun:1.3-alpine AS builder

WORKDIR /app

# Copy only production dependencies first
COPY package.json bun.lockb* ./
COPY packages/database ./packages/database
COPY apps/api ./apps/api

# Install only production dependencies to reduce bundle size
RUN bun install --frozen-lockfile --production

# Change to API directory for compilation
WORKDIR /app/apps/api

# Compile with maximum optimization flags
RUN echo "=== Optimized compilation ===" && \
    bun build src/index.ts \
    --compile \
    --outfile=app \
    --target=bun-linux-x64 \
    --minify \
    --minify-whitespace \
    --minify-syntax \
    --splitting=false \
    --external-bundles=false && \
    chmod +x app && \
    echo "Optimized executable size: $(du -h app)" && \
    strip app 2>/dev/null || echo "Strip not available" && \
    echo "After strip: $(du -h app)"

# Ultra-minimal runtime stage
FROM scratch AS minimal-runtime

# Copy only the executable - no OS layer
COPY --from=builder /app/apps/api/app /app

# Expose port
EXPOSE 3001

# Run the app
ENTRYPOINT ["/app"]